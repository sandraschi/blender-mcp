name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'mcpb/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'mcpb/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  PACKAGE_NAME: blender-mcp

jobs:
  # ========================================================================================
  # QUALITY GATES - Code Quality & Security
  # ========================================================================================
  quality-gate:
    name: ğŸ” Quality Gate
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: ğŸ”§ Run quality checks
      run: make quality

    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: ğŸ”’ Security scan with Bandit
      run: |
        pip install bandit
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ --exit-zero

    - name: ğŸ›¡ï¸ Upload security scan results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: bandit-report.json
      if: always()

  # ========================================================================================
  # MCPB VALIDATION - Package Integrity
  # ========================================================================================
  mcpb-validation:
    name: ğŸ“¦ MCPB Validation
    runs-on: ubuntu-latest
    needs: quality-gate
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install MCPB CLI
      run: npm install -g @anthropic-ai/mcpb

    - name: ğŸ” Validate MCPB structure
      run: |
        cd mcpb
        mcpb validate

    - name: ğŸ§ª Test MCPB build (dry run)
      run: |
        cd mcpb
        mcpb pack . ../dist/${{ env.PACKAGE_NAME }}.mcpb --no-sign --dry-run

  # ========================================================================================
  # CROSS-PLATFORM TESTING - Windows, Mac, Linux
  # ========================================================================================
  cross-platform-test:
    name: ğŸ–¥ï¸ Test ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: quality-gate
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: [3.9, 3.10, 3.11]
        exclude:
          # Reduce matrix size - test all OS on latest Python, test older Python only on Ubuntu
          - os: windows-latest
            python-version: 3.9
          - os: windows-latest
            python-version: 3.10
          - os: macos-latest
            python-version: 3.9
          - os: macos-latest
            python-version: 3.10
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: ğŸ§ª Run platform-specific tests
      run: |
        python -c "import blender_mcp; print('âœ… Import successful')"
        make test-unit

  # ========================================================================================
  # BUILD & RELEASE - Automated Package Creation
  # ========================================================================================
  build-release:
    name: ğŸ—ï¸ Build & Release
    runs-on: ubuntu-latest
    needs: [quality-gate, mcpb-validation, cross-platform-test]
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      release_notes: ${{ steps.release-notes.outputs.notes }}
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“¦ Install build tools
      run: |
        pip install build twine
        npm install -g @anthropic-ai/mcpb

    - name: ğŸ”¢ Determine version
      id: version
      run: |
        # Get current version from pyproject.toml
        CURRENT_VERSION=$(grep -oP '(?<=version = ")[^"]*' pyproject.toml)
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

        # Determine next version based on trigger
        if [[ "${{ github.event_name }}" == "release" ]]; then
          # Use release tag
          VERSION="${{ github.event.release.tag_name }}"
        elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # Use input release type
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          # Parse current version
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          case $RELEASE_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          VERSION="$MAJOR.$MINOR.$PATCH"
        else
          # For push/PR, just use current version
          VERSION="$CURRENT_VERSION"
        fi

        TAG="v$VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: ğŸ“ Generate changelog
      id: changelog
      run: |
        # Generate changelog from git history
        if [ -f CHANGELOG.md ]; then
          echo "CHANGELOG.md exists, updating..."
        else
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
        fi

        # Get commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          git log --pretty=format:"* %s (%h)" "$LAST_TAG..HEAD" >> temp_changes.txt
        else
          git log --pretty=format:"* %s (%h)" --max-count=20 >> temp_changes.txt
        fi

        # Create version entry
        echo "" >> CHANGELOG.md
        echo "## ${{ steps.version.outputs.version }} - $(date +%Y-%m-%d)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        cat temp_changes.txt >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Read changelog for release notes
        RELEASE_NOTES=$(head -50 CHANGELOG.md | grep -A 50 "## ${{ steps.version.outputs.version }}" | head -20)
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ğŸ“¦ Build MCPB package
      run: make mcpb-build

    - name: ğŸ” Sign MCPB package
      run: |
        # Create self-signed certificate for demo (replace with real cert in production)
        openssl req -x509 -newkey rsa:4096 -keyout signing-key.pem -out signing-cert.pem -days 365 -nodes -subj "/C=US/ST=CA/L=San Francisco/O=FlowEngineer/CN=sandraschi"

        # Sign the package
        mcpb sign --key signing-key.pem dist/${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.version }}.mcpb
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    - name: ğŸ“‹ Generate distribution assets
      run: |
        cd dist
        # Generate SHA256 checksums
        sha256sum ${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.version }}.mcpb > ${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.version }}.sha256

        # Create install script for different platforms
        cat > install-linux.sh << 'EOF'
        #!/bin/bash
        # Blender MCP Linux Installer
        echo "ğŸš€ Installing Blender MCP..."
        # Add installation logic here
        EOF
        chmod +x install-linux.sh

        cat > install-windows.ps1 << 'EOF'
        # Blender MCP Windows Installer
        Write-Host "ğŸš€ Installing Blender MCP..."
        # Add installation logic here
        EOF

    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ steps.version.outputs.version }}
        path: |
          dist/
          CHANGELOG.md

  # ========================================================================================
  # RELEASE PUBLISHING - GitHub Releases
  # ========================================================================================
  release:
    name: ğŸ‰ Publish Release
    runs-on: ubuntu-latest
    needs: build-release
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    steps:
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}

    - name: ğŸ“ Generate release notes
      id: release-notes
      run: |
        # Create comprehensive release notes
        cat > release_notes.md << EOF
        ## ğŸ¨ Blender MCP ${{ needs.build-release.outputs.version }}

        **AI-Powered 3D Creation - Control Blender with Chat!**

        ### âœ¨ What's New

        ${{ needs.build-release.outputs.release_notes }}

        ### ğŸš€ Quick Install

        **Option 1 - Drag & Drop (Easiest):**
        1. Download \`${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.mcpb\`
        2. Drag into Claude Desktop
        3. Done! ğŸ‰

        **Option 2 - One Command:**
        \`\`\`bash
        uvx mcpb install sandraschi/blender-mcp
        \`\`\`

        ### ğŸ“¦ Downloads

        - **MCPB Package**: \`${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.mcpb\`
        - **SHA256 Checksum**: \`${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.sha256\`
        - **Source Code**: See source tab

        ### ğŸ”§ System Requirements

        - Claude Desktop
        - Blender 3.0+
        - Python 3.8+
        - 4GB RAM recommended

        ### ğŸ“š Documentation

        - [Installation Guide](https://github.com/sandraschi/blender-mcp#installation)
        - [Usage Examples](https://github.com/sandraschi/blender-mcp#usage)
        - [API Reference](https://github.com/sandraschi/blender-mcp#api)

        ### ğŸ™ Acknowledgments

        Built with â¤ï¸ by [FlowEngineer sandraschi](https://github.com/sandraschi)

        Special thanks to the Blender and MCP communities!
        EOF

    - name: ğŸ¯ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.build-release.outputs.tag }}
        name: ${{ env.PACKAGE_NAME }} ${{ needs.build-release.outputs.version }}
        body_path: release_notes.md
        files: |
          dist/${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.mcpb
          dist/${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.sha256
          dist/install-linux.sh
          dist/install-windows.ps1
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ Update version in pyproject.toml
      if: github.event_name != 'release'
      run: |
        # Update version in pyproject.toml
        sed -i "s/version = \".*\"/version = \"${{ needs.build-release.outputs.version }}\"/" pyproject.toml

        # Commit version update
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add pyproject.toml
        git commit -m "ğŸ”– Bump version to ${{ needs.build-release.outputs.version }}" || true

    - name: ğŸ“¢ Notify on Discord/Slack (optional)
      run: |
        # Add webhook notifications here if desired
        echo "Release ${{ needs.build-release.outputs.version }} published successfully!"
      if: success()

  # ========================================================================================
  # PyPI PUBLISHING - Universal Python Distribution
  # ========================================================================================
  publish-pypi:
    name: ğŸ“¦ Publish to PyPI
    runs-on: ubuntu-latest
    needs: build-release
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: pypi
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: ğŸ—ï¸ Build distribution packages
      run: python -m build

    - name: ğŸ“¤ Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*.whl dist/*.tar.gz

  # ========================================================================================
  # DOCKER IMAGE BUILDING - Container Distribution
  # ========================================================================================
  build-docker:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: build-release
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¦ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=${{ needs.build-release.outputs.version }}

    - name: ğŸ—ï¸ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ========================================================================================
  # DEPLOYMENT - Registry Publishing
  # ========================================================================================
  deploy-registry:
    name: ğŸŒ Deploy to Registries
    runs-on: ubuntu-latest
    needs: [release, publish-pypi, build-docker]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production
    steps:
    - name: ğŸ“¥ Download release artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}

    - name: ğŸŒ Publish to MCP Registry (Future)
      run: |
        # When MCP registry becomes available:
        # mcpb publish --registry https://registry.mcpb.anthropic.com dist/${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.mcpb
        echo "MCP Registry publishing will be enabled when available"
        echo "Package ready for registry: dist/${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.mcpb"

    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ“¦ PyPI: https://pypi.org/project/${{ env.PACKAGE_NAME }}/"
        echo "ğŸ³ Docker: ghcr.io/${{ github.repository }}:${{ needs.build-release.outputs.version }}"
        echo "ğŸ“‹ MCPB: Available in GitHub Releases"
        echo "ğŸ·ï¸ Tag: ${{ needs.build-release.outputs.tag }}"

  # ========================================================================================
  # MONITORING - Post-Release Analytics
  # ========================================================================================
  analytics:
    name: ğŸ“Š Release Analytics
    runs-on: ubuntu-latest
    needs: release
    if: success()
    steps:
    - name: ğŸ“ˆ Log release metrics
      run: |
        echo "ğŸ‰ Release ${{ needs.build-release.outputs.version }} completed successfully!"
        echo "ğŸ“¦ Package: ${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.mcpb"
        echo "ğŸ·ï¸ Tag: ${{ needs.build-release.outputs.tag }}"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build-release.outputs.tag }}"

        # Calculate file sizes
        if [ -f "dist/${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.mcpb" ]; then
          SIZE=$(stat -c%s "dist/${{ env.PACKAGE_NAME }}-${{ needs.build-release.outputs.version }}.mcpb")
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "ğŸ“ Package size: ${SIZE_MB}MB"
        fi

        # Future: Send metrics to analytics service
        echo "âœ… CI/CD pipeline completed successfully"
